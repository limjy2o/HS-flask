<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單字測驗系統</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border-color: #d0d0d0;
            --hover-bg: #f5f5f5;
            --section-bg: #fafafa;
        }
        
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --border-color: #404040;
            --hover-bg: #2a2a2a;
            --section-bg: #222222;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2rem;
        }
        
        .theme-toggle {
            padding: 8px 16px;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 1rem;
            font-family: inherit;
        }
        
        .theme-toggle:hover {
            background: var(--hover-bg);
        }
        
        .section {
            background: var(--section-bg);
            border: 1px solid var(--border-color);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .upload-area {
            text-align: center;
            padding: 30px;
            background: var(--bg-color);
            border: 2px dashed var(--border-color);
            margin-bottom: 20px;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background: var(--hover-bg);
        }
        
        .btn {
            padding: 10px 20px;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            font-family: inherit;
        }
        
        .btn:hover {
            background: var(--hover-bg);
        }
        
        .btn-danger {
            background: #ffffff;
            color: #000000;
            border: 1px solid #000000;
        }
        
        .btn-danger:hover {
            background: #000000;
            color: #ffffff;
        }
        
        .bank-list {
            display: grid;
            gap: 10px;
        }
        
        .bank-item {
            background: var(--bg-color);
            padding: 15px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .checkbox-label:hover {
            background: var(--hover-bg);
        }
        
        .checkbox-label.selected {
            background: var(--hover-bg);
            border-color: var(--text-color);
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .radio-label input[type="radio"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .custom-input {
            width: 100px;
            padding: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
            margin-left: 10px;
            font-family: inherit;
        }
        
        .info-text {
            margin-top: 15px;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .start-button {
            text-align: center;
            margin-top: 30px;
        }
        
        .start-button .btn {
            font-size: 1.2rem;
            padding: 12px 40px;
            background: var(--text-color);
            color: var(--bg-color);
        }
        
        .start-button .btn:hover {
            opacity: 0.85;
        }
        
        .message {
            padding: 15px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            display: none;
            background: var(--section-bg);
        }
        
        .message.show {
            display: block;
        }
        
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>單字測驗系統</h1>
            <button class="theme-toggle" onclick="toggleTheme()">切換深色/淺色模式</button>
        </div>
        
        <div id="message" class="message"></div>
        
        <!-- 題庫管理 -->
        <div class="section">
            <div class="section-title">題庫管理</div>
            
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <p style="margin-bottom: 10px;">點擊上傳題庫檔案</p>
                <p style="font-size: 0.9rem; opacity: 0.7;">支援 .txt 格式 (Tab 分隔: 單字、詞性、中文解釋)</p>
                <input type="file" id="fileInput" accept=".txt" onchange="uploadBank(event)">
            </div>
            
            {% if banks %}
            <div class="bank-list">
                {% for name, bank in banks.items() %}
                <div class="bank-item">
                    <span>{{ name }} ({{ bank.questions|length }} 題)</span>
                    <button class="btn btn-danger" onclick="deleteBank('{{ name }}')">刪除</button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="text-align: center; padding: 20px; opacity: 0.7;">尚未上傳任何題庫</p>
            {% endif %}
        </div>
        
        {% if banks %}
        <!-- 題庫選擇 -->
        <div class="section">
            <div class="section-title">題庫選擇</div>
            
            <p style="margin-bottom: 15px; font-weight: bold;">選擇要使用的題庫:</p>
            <div class="checkbox-group" id="bankCheckboxGroup">
                {% for name, bank in banks.items() %}
                <label class="checkbox-label" data-bank="{{ name }}">
                    <input type="checkbox" name="bank" value="{{ name }}" onchange="updateQuestionCount()">
                    {{ name }} ({{ bank.questions|length }} 題)
                </label>
                {% endfor %}
            </div>
            
            <p style="margin-top: 20px; margin-bottom: 15px; font-weight: bold;">題數選擇:</p>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="count_mode" value="0.5" onchange="toggleCustomInput()">
                    1/2
                </label>
                <label class="radio-label">
                    <input type="radio" name="count_mode" value="0.67" onchange="toggleCustomInput()">
                    2/3
                </label>
                <label class="radio-label">
                    <input type="radio" name="count_mode" value="0.75" checked onchange="toggleCustomInput()">
                    3/4
                </label>
                <label class="radio-label">
                    <input type="radio" name="count_mode" value="1.0" onchange="toggleCustomInput()">
                    全部
                </label>
                <label class="radio-label">
                    <input type="radio" name="count_mode" value="custom" onchange="toggleCustomInput()">
                    自訂: <input type="number" id="customCount" class="custom-input" value="100" min="1" onclick="selectCustomMode(event)"> 題
                </label>
            </div>
            
            <p id="totalCountText" class="info-text"></p>
        </div>
        
        <!-- 測驗模式 -->
        <div class="section">
            <div class="section-title">測驗模式</div>
            
            <p style="margin-bottom: 15px; font-weight: bold;">選擇測驗模式:</p>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="test_mode" value="A" checked>
                    中文解釋及詞性測驗
                </label>
                <label class="radio-label">
                    <input type="radio" name="test_mode" value="B">
                    拼字測驗
                </label>
                <label class="radio-label">
                    <input type="radio" name="test_mode" value="C">
                    混合模式
                </label>
            </div>
        </div>
        
        <!-- 開始測驗 -->
        <div class="start-button">
            <button class="btn" onclick="startQuiz()">開始測驗</button>
        </div>
        {% endif %}
    </div>
    
    <script>
        // 主題切換
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        // 載入儲存的主題
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
        
        function showMessage(text) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message show';
            setTimeout(() => msg.classList.remove('show'), 5000);
        }
        
        // 點擊自訂題數輸入框時自動選中自訂選項
        function selectCustomMode(event) {
            event.stopPropagation();
            const customRadio = document.querySelector('input[name="count_mode"][value="custom"]');
            customRadio.checked = true;
            toggleCustomInput();
        }
        
        // 切換自訂輸入框狀態
        function toggleCustomInput() {
            const customRadio = document.querySelector('input[name="count_mode"][value="custom"]');
            const customInput = document.getElementById('customCount');
            if (customRadio && customRadio.checked) {
                customInput.removeAttribute('disabled');
                customInput.focus();
            } else {
                customInput.setAttribute('disabled', 'disabled');
            }
        }
        
        // 初始化自訂輸入框狀態
        (function() {
            toggleCustomInput();
            
            // 為 checkbox 添加視覺回饋
            const checkboxes = document.querySelectorAll('.checkbox-label input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const label = this.closest('.checkbox-label');
                    if (this.checked) {
                        label.classList.add('selected');
                    } else {
                        label.classList.remove('selected');
                    }
                });
            });
            
            // 為題數選項添加事件監聽器
            const countModeRadios = document.querySelectorAll('input[name="count_mode"]');
            countModeRadios.forEach(radio => {
                radio.addEventListener('change', updateQuestionCount);
            });
            
            // 為自訂題數輸入框添加事件監聽器
            const customCountInput = document.getElementById('customCount');
            if (customCountInput) {
                customCountInput.addEventListener('input', function() {
                    const customRadio = document.querySelector('input[name="count_mode"][value="custom"]');
                    if (customRadio && customRadio.checked) {
                        updateQuestionCount();
                    }
                });
            }
        })();
        
        async function uploadBank(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage(data.message);
                }
            } catch (error) {
                showMessage('上傳失敗,請稍後再試');
            }
            
            event.target.value = '';
        }
        
        async function deleteBank(bankName) {
            if (!confirm(`確定要刪除題庫 '${bankName}' 嗎?\n此操作無法復原。`)) {
                return;
            }
            
            try {
                const response = await fetch(`/delete_bank/${encodeURIComponent(bankName)}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showMessage(data.message);
                }
            } catch (error) {
                showMessage('刪除失敗,請稍後再試');
            }
        }
        
        async function updateQuestionCount() {
            const selected = Array.from(document.querySelectorAll('input[name="bank"]:checked'))
                .map(cb => cb.value);
            
            const totalCountText = document.getElementById('totalCountText');
            
            if (selected.length === 0) {
                totalCountText.textContent = '';
                return;
            }
            
            try {
                const response = await fetch('/get_bank_count', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({selected_banks: selected})
                });
                const data = await response.json();
                
                const total = data.total;
                const countMode = document.querySelector('input[name="count_mode"]:checked').value;
                
                let displayText = `已選題庫總題數: ${total} 題`;
                
                // 顯示實際會抽取的題數
                if (countMode === 'custom') {
                    const customCount = parseInt(document.getElementById('customCount').value) || 0;
                    const actualCount = Math.min(customCount, total);
                    displayText += ` → 將抽取 ${actualCount} 題`;
                } else if (countMode !== '1.0') {
                    const ratio = parseFloat(countMode);
                    const actualCount = Math.max(1, Math.round(total * ratio));
                    displayText += ` → 將抽取 ${actualCount} 題`;
                } else {
                    displayText += ` → 將抽取全部`;
                }
                
                totalCountText.textContent = displayText;
            } catch (error) {
                console.error('Error updating question count:', error);
            }
        }
        
        async function startQuiz() {
            const selected = Array.from(document.querySelectorAll('input[name="bank"]:checked'))
                .map(cb => cb.value);
            
            if (selected.length === 0) {
                showMessage('請至少選擇一個題庫');
                return;
            }
            
            const countMode = document.querySelector('input[name="count_mode"]:checked').value;
            let customCount = document.getElementById('customCount').value;
            const testMode = document.querySelector('input[name="test_mode"]:checked').value;
            
            // 驗證自訂題數
            if (countMode === 'custom') {
                const customCountNum = parseInt(customCount);
                if (isNaN(customCountNum) || customCountNum < 1) {
                    showMessage('請輸入有效的題數 (至少 1 題)');
                    return;
                }
            }
            
            console.log('Starting quiz with:', {
                selected_banks: selected,
                count_mode: countMode,
                custom_count: customCount,
                test_mode: testMode
            });
            
            try {
                const response = await fetch('/start_quiz', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        selected_banks: selected,
                        count_mode: countMode,
                        custom_count: customCount,
                        test_mode: testMode
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Server response:', data);
                
                if (data.success) {
                    window.location.href = data.redirect;
                } else {
                    showMessage(data.message || '啟動測驗失敗');
                }
            } catch (error) {
                console.error('Error starting quiz:', error);
                showMessage('啟動測驗失敗,請稍後再試: ' + error.message);
            }
        }
    </script>
</body>
</html>