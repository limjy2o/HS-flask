<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測驗結果</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border-color: #d0d0d0;
            --hover-bg: #f5f5f5;
            --section-bg: #fafafa;
            --correct-bg: #e8f5e9;
            --incorrect-bg: #ffebee;
        }
        
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --border-color: #404040;
            --hover-bg: #2a2a2a;
            --section-bg: #222222;
            --correct-bg: #1b5e20;
            --incorrect-bg: #b71c1c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 1.8rem;
        }
        
        .theme-toggle {
            padding: 8px 16px;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 1rem;
            font-family: inherit;
        }
        
        .theme-toggle:hover {
            background: var(--hover-bg);
        }
        
        .stats {
            background: var(--section-bg);
            border: 1px solid var(--border-color);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: var(--bg-color);
            padding: 20px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1rem;
            opacity: 0.7;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .result-table th {
            background: var(--section-bg);
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border: 1px solid var(--border-color);
        }
        
        .result-table td {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        .question-num {
            text-align: center;
            font-weight: bold;
            width: 60px;
        }
        
        .word-cell {
            min-width: 150px;
        }
        
        .pos-cell {
            min-width: 150px;
        }
        
        .meaning-cell {
            min-width: 250px;
        }
        
        .user-answer-row {
            background: var(--section-bg);
        }
        
        .correct-answer-row {
            font-weight: bold;
        }
        
        .correct-answer-row.correct {
            background: var(--correct-bg);
        }
        
        .correct-answer-row.incorrect {
            background: var(--incorrect-bg);
        }
        
        .status-cell {
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .answer-display {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .separator {
            font-weight: bold;
            color: #666;
        }
        
        .word-display {
            font-family: "Merriweather", Georgia, serif;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
        }
        
        .btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            font-family: inherit;
        }
        
        .btn:hover {
            background: var(--hover-bg);
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin: 30px 0 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>測驗結果</h1>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">切換深色/淺色模式</button>
        </div>
        
        <!-- 統計資訊 -->
        <div class="stats">
            <h2 style="margin-bottom: 15px;">測驗統計</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">{{ total_questions }}</div>
                    <div class="stat-label">總題數</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ correct_count }}</div>
                    <div class="stat-label">答對</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ total_questions - correct_count }}</div>
                    <div class="stat-label">答錯</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ "%.1f"|format(accuracy) }}%</div>
                    <div class="stat-label">正確率</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ total_time // 60 }}:{{ "%02d"|format(total_time % 60) }}</div>
                    <div class="stat-label">答題時間</div>
                </div>
            </div>
        </div>
        
        <!-- 詳細結果 -->
        <h2 class="section-title">詳細結果</h2>
        <table class="result-table">
            <thead>
                <tr>
                    <th>題號</th>
                    <th>單字</th>
                    <th>詞性</th>
                    <th>中文解釋</th>
                </tr>
            </thead>
            <tbody>
                {% for i in range(results|length) %}
                {% set result = results[i] %}
                {% set question = result.question %}
                {% set is_correct = result.correct %}
                
                <!-- 使用者答案 -->
                <tr class="user-answer-row">
                    <td class="question-num" rowspan="2">{{ i + 1 }}</td>
                    
                    <!-- 單字 -->
                    <td class="word-cell">
                        {% if result.mode == 'A' %}
                            <span class="word-display">{{ question.word }}</span>
                        {% else %}
                            <span class="word-display">{{ result.user_word if result.user_word else '(未填寫)' }}</span>
                        {% endif %}
                    </td>
                    
                    <!-- 詞性 -->
                    <td class="pos-cell">
                        <div class="answer-display">
                            {% if result.mode == 'A' %}
                                {% if result.user_pos_list and result.user_pos_list|length > 0 %}
                                    {% for idx in range(result.user_pos_list|length) %}
                                        {% if idx > 0 %}<span class="separator">&</span>{% endif %}
                                        <span>{{ result.user_pos_list[idx] if result.user_pos_list[idx] else '(未填寫)' }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span>(未填寫)</span>
                                {% endif %}
                            {% else %}
                                {% set pos_list = question.pos.split('&') %}
                                {% for idx in range(pos_list|length) %}
                                    {% if idx > 0 %}<span class="separator">&</span>{% endif %}
                                    <span>{{ pos_list[idx].strip() }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </td>
                    
                    <!-- 中文解釋 (使用者答案) -->
                    <td class="meaning-cell">
                        {% if result.mode == 'A' %}
                            <div class="answer-display">
                                {% if result.user_meaning_list and result.user_meaning_list|length > 0 %}
                                    {% for idx in range(result.user_meaning_list|length) %}
                                        {% if idx > 0 %}
                                            {% if (question.meaning.split('&')|length > 1) and ((idx % (question.meaning.replace('、', '&').split('&')|length / question.meaning.split('&')|length)|int) == 0) %}
                                                <span class="separator">&</span>
                                            {% else %}
                                                <span class="separator">、</span>
                                            {% endif %}
                                        {% endif %}
                                        <span>{{ result.user_meaning_list[idx] if result.user_meaning_list[idx] else '(未填寫)' }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span>(未填寫)</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="answer-display">
                                {% set parts = question.meaning.split('&') %}
                                {% for part_idx in range(parts|length) %}
                                    {% if part_idx > 0 %}<span class="separator">&</span>{% endif %}
                                    {% set sub_meanings = parts[part_idx].split('、') %}
                                    {% for sub_idx in range(sub_meanings|length) %}
                                        {% if sub_idx > 0 %}<span class="separator">、</span>{% endif %}
                                        <span>{{ sub_meanings[sub_idx].strip() }}</span>
                                    {% endfor %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </td>
                </tr>
                
                <!-- 正確答案 -->
                <tr class="correct-answer-row {% if is_correct %}correct{% else %}incorrect{% endif %}">
                    <!-- 單字 -->
                    <td class="word-cell">
                        <span class="word-display">{{ question.word }}</span>
                    </td>
                    
                    <!-- 詞性 -->
                    <td class="pos-cell">
                        <div class="answer-display">
                            {% set pos_list = question.pos.split('&') %}
                            {% for idx in range(pos_list|length) %}
                                {% if idx > 0 %}<span class="separator">&</span>{% endif %}
                                <span>{{ pos_list[idx].strip() }}</span>
                            {% endfor %}
                        </div>
                    </td>
                    
                    <!-- 中文解釋 (正確答案) -->
                    <td class="meaning-cell">
                        <div class="answer-display">
                            {% set parts = question.meaning.split('&') %}
                            {% for part_idx in range(parts|length) %}
                                {% if part_idx > 0 %}<span class="separator">&</span>{% endif %}
                                {% set sub_meanings = parts[part_idx].split('、') %}
                                {% for sub_idx in range(sub_meanings|length) %}
                                    {% if sub_idx > 0 %}<span class="separator">、</span>{% endif %}
                                    <span>{{ sub_meanings[sub_idx].strip() }}</span>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </td>
                </tr>
                
                <!-- 狀態列 -->
                <tr>
                    <td colspan="4" class="status-cell">
                        {% if is_correct %}
                            ✓ 正確
                        {% else %}
                            ✗ 錯誤
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="button-group">
            <button class="btn" onclick="window.location.href='/'">返回主頁</button>
        </div>
    </div>
    
    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</body>
</html>